models:
  - name: int_add_streak
    tests:
      - dbt_utils.expression_is_true:
          name: "verify_buckets_mutually_exclusive"
          description: |
            Done and wontdo buckets are mutually exclusive:
            - One will always be null if the other has valid int value.
            - Otherwise, both should be null.

          expression: |
            todo_done_habit_bucket_id + todo_wontdo_habit_bucket_id != 0
          config:
            where: |
              todo_done_habit_bucket_id IS NOT NULL
              AND 
              todo_wontdo_habit_bucket_id IS NOT NULL
      - dbt_utils.expression_is_true:
          name: "verify_valid_streak_for_non_null_bucket"
          description: |
            Verify that for each non-null buckets, an equivalent non 0 streak is calcualted.
            If both are NULL, the status MUST be 0 (new)
          expression: |
            (todo_done_habit_bucket_id IS NOT NULL AND todo_done_streak != 0)
            OR
            (todo_wontdo_habit_bucket_id IS NOT NULL AND todo_wontdo_streak != 0)
            OR
            (todo_wontdo_habit_bucket_id IS NULL AND todo_wontdo_habit_bucket_id IS NULL AND todo_status = '0')
    columns:
      - name: max_streak
        data_type: bigint
      - name: todo_done_streak
        data_type: bigint
      - name: todo_done_habit_bucket_id
        data_type: bigint
      - name: todo_wontdo_habit_bucket_id
        data_type: bigint

      - name: todo_id
        data_type: text
        data_tests:
          - unique:
              config:
                error_if: ">10"
      - name: todo_title
        data_type: text
      - name: todo_projectid
        data_type: text
      - name: todo_repeatflag
        data_type: text
      - name: todo_repeattaskid
        data_type: text
      - name: todo_status
        data_type: text
      - name: todo_derived__is_repeat
        data_type: boolean
      - name: todo_completedtime
        data_type: timestamp without time zone
      - name: todo_duedate
        data_type: timestamp without time zone
      - name: todo_done_max_streak
        data_type: bigint
      - name: todo_done_total_attempts
        data_type: bigint
